name: Netlify Deploy Status

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
  pull_request_target:
    types: [opened, synchronize, reopened]
  push:
    branches: [main]

jobs:
  notify:
    name: Netlify Deploy Status
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      contents: read
      checks: read
      deployments: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Post Initial Comment and Wait for Preview URL
        if: github.event_name == 'pull_request' || github.event_name == 'pull_request_target'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const prAuthor = context.payload.pull_request.user.login;
            const branchName = context.payload.pull_request.head.ref;
            
            if (context.payload.action === 'opened' || context.payload.action === 'synchronize') {
              // Post initial comment
              const initialComment = [
                '## üöÄ Preview Deployment',
                '',
                'A preview deployment is being created automatically on Netlify.',
                '',
                '**Preview URL**: ‚è≥ Waiting for Netlify to finish building...',
                '',
                '**Note**:',
                '- ‚úÖ Preview deployments are automatic (no approval needed)',
                '- ‚è≥ Production deployment will happen automatically after this PR is merged to `main`',
                '- üîí Only merged PRs deploy to production',
                '',
                '**Status**: Netlify is building your preview...'
              ].join('\n');
              
              let commentId;
              try {
                const comment = await github.rest.issues.createComment({
                  issue_number: prNumber,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: initialComment
                });
                commentId = comment.data.id;
                console.log('‚úÖ Initial comment posted successfully');
              } catch (error) {
                console.error('‚ùå Failed to post comment:', error.message);
                return;
              }
              
              // Wait for Netlify to create the deploy preview
              // Poll for the preview URL from Netlify status checks
              console.log('‚è≥ Waiting for Netlify deployment...');
              
              let previewUrl = null;
              const maxAttempts = 30; // Wait up to 5 minutes (30 * 10 seconds)
              
              for (let attempt = 0; attempt < maxAttempts; attempt++) {
                await new Promise(resolve => setTimeout(resolve, 10000)); // Wait 10 seconds
                
                try {
                  // Get all check runs for this PR
                  const checks = await github.rest.checks.listForRef({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    ref: context.payload.pull_request.head.sha
                  });
                  
                  // Look for Netlify check run
                  const netlifyCheck = checks.data.check_runs.find(
                    check => check.name.toLowerCase().includes('netlify') || 
                             check.app?.name?.toLowerCase().includes('netlify')
                  );
                  
                  if (netlifyCheck) {
                    // Try to extract preview URL from Netlify check output or details
                    // Netlify preview URLs typically follow pattern: deploy-preview-{PR_NUMBER}--{site-name}.netlify.app
                    // Try to get from check output first
                    if (netlifyCheck.output && netlifyCheck.output.summary) {
                      const urlMatch = netlifyCheck.output.summary.match(/https?:\/\/[^\s\)]+deploy-preview[^\s\)]+/i);
                      if (urlMatch) {
                        previewUrl = urlMatch[0];
                        console.log('‚úÖ Found preview URL from check output:', previewUrl);
                        if (netlifyCheck.status === 'completed') break;
                      }
                    }
                    
                    // If check is complete, try to construct URL from common pattern
                    if (netlifyCheck.status === 'completed') {
                      if (netlifyCheck.conclusion === 'success' && !previewUrl) {
                        // Try common Netlify preview URL pattern
                        // This will work if Netlify follows standard naming
                        const detailsUrl = netlifyCheck.details_url;
                        if (detailsUrl && detailsUrl.includes('netlify.app')) {
                          previewUrl = detailsUrl;
                        } else {
                          // Fallback: construct URL (user can set NETLIFY_SITE_NAME env var)
                          const siteName = process.env.NETLIFY_SITE_NAME || context.repo.repo.replace(/[^a-z0-9-]/gi, '-').toLowerCase();
                          previewUrl = `https://deploy-preview-${prNumber}--${siteName}.netlify.app`;
                        }
                        console.log('‚úÖ Constructed preview URL:', previewUrl);
                      } else if (netlifyCheck.conclusion === 'failure') {
                        console.log('‚ùå Netlify deployment failed');
                        break;
                      }
                      break;
                    }
                  }
                  
                  // Also check for deployment status via GitHub deployments API
                  try {
                    const deployments = await github.rest.repos.listDeployments({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      ref: context.payload.pull_request.head.sha,
                      environment: 'preview'
                    });
                    
                    if (deployments.data.length > 0) {
                      const deployment = deployments.data[0];
                      const statuses = await github.rest.repos.listDeploymentStatuses({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        deployment_id: deployment.id
                      });
                      
                      if (statuses.data.length > 0) {
                        const status = statuses.data[0];
                        if (status.environment_url) {
                          previewUrl = status.environment_url;
                          console.log('‚úÖ Found preview URL from deployment:', previewUrl);
                          break;
                        }
                      }
                    }
                  } catch (deployError) {
                    // Deployment API might not be available, continue polling
                    console.log('‚ÑπÔ∏è  Deployment API not available, continuing to poll...');
                  }
                  
                } catch (error) {
                  console.log(`Attempt ${attempt + 1}/${maxAttempts}: ${error.message}`);
                }
              }
              
              // Update comment with preview URL
              const updatedComment = [
                '## üöÄ Preview Deployment',
                '',
                'A preview deployment has been created automatically on Netlify.',
                '',
                previewUrl 
                  ? `**Preview URL**: [${previewUrl}](${previewUrl}) üéâ`
                  : '**Preview URL**: ‚ö†Ô∏è Could not retrieve preview URL. Please check Netlify dashboard.',
                '',
                '**Note**:',
                '- ‚úÖ Preview deployments are automatic (no approval needed)',
                '- ‚è≥ Production deployment will happen automatically after this PR is merged to `main`',
                '- üîí Only merged PRs deploy to production',
                '',
                previewUrl 
                  ? '**Status**: ‚úÖ Preview deployment is ready!'
                  : '**Status**: ‚ö†Ô∏è Please check Netlify dashboard for deployment status'
              ].join('\n');
              
              try {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: commentId,
                  body: updatedComment
                });
                console.log('‚úÖ Comment updated with preview URL');
              } catch (error) {
                console.error('‚ùå Failed to update comment:', error.message);
              }
            }
      
      - name: Success Message
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "‚úÖ Code pushed to main branch"
          echo "üöÄ Production deployment will be triggered on Netlify"

